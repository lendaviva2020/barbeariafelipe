{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Configura√ß√µes de IA - Painel Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">‚öôÔ∏è Configura√ß√µes de IA</h1>
        <p class="text-gray-600 mt-2">Configure o comportamento da intelig√™ncia artificial para cada barbeiro</p>
    </div>

    <!-- Estat√≠sticas de IA -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Total de Mensagens</p>
                    <p id="total-messages" class="text-2xl font-bold">0</p>
                </div>
                <div class="text-blue-500 text-3xl">üí¨</div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Respostas da IA</p>
                    <p id="ai-messages" class="text-2xl font-bold">0</p>
                </div>
                <div class="text-green-500 text-3xl">ü§ñ</div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Requer Aten√ß√£o</p>
                    <p id="requires-attention" class="text-2xl font-bold">0</p>
                </div>
                <div class="text-yellow-500 text-3xl">‚ö†Ô∏è</div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Taxa de Resposta</p>
                    <p id="response-rate" class="text-2xl font-bold">0%</p>
                </div>
                <div class="text-purple-500 text-3xl">üìä</div>
            </div>
        </div>
    </div>

    <!-- Lista de Configura√ß√µes por Barbeiro -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-semibold">Configura√ß√µes por Barbeiro</h2>
            <button onclick="loadSettings()" class="btn btn-secondary">
                üîÑ Atualizar
            </button>
        </div>
        
        <div id="settings-list" class="p-4">
            <!-- Configura√ß√µes ser√£o carregadas aqui -->
            <div class="text-center text-gray-500 py-8">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-600 rounded-full"></div>
                <p class="mt-2">Carregando configura√ß√µes...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold">Editar Configura√ß√µes de IA</h3>
        </div>
        
        <form id="edit-form" class="p-6 space-y-4">
            <input type="hidden" id="setting-id">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Barbeiro</label>
                <input type="text" id="barber-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
            </div>
            
            <div>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="is-enabled" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm font-medium text-gray-700">IA Habilitada</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">Ativar/desativar respostas autom√°ticas da IA</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Personalidade</label>
                <select id="personality" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="friendly">Amig√°vel</option>
                    <option value="professional">Profissional</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Instru√ß√µes Personalizadas</label>
                <textarea id="custom-instructions" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Instru√ß√µes espec√≠ficas para personalizar o comportamento da IA..."></textarea>
                <p class="text-xs text-gray-500 mt-1">Exemplo: "Sempre mencionar os servi√ßos premium" ou "Focar em produtos de cuidados com barba"</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tamanho M√°ximo da Mensagem</label>
                    <input type="number" id="max-message-length" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="100" max="5000" value="1000">
                    <p class="text-xs text-gray-500 mt-1">100-5000 caracteres</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tempo de Resposta (seg)</label>
                    <input type="number" id="response-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" max="60" value="5">
                    <p class="text-xs text-gray-500 mt-1">1-60 segundos</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Salvar Configura√ß√µes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Carregar estat√≠sticas
async function loadStats() {
    try {
        const response = await fetch('/api/ai/stats/', {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const stats = await response.json();
            document.getElementById('total-messages').textContent = stats.total_messages || 0;
            document.getElementById('ai-messages').textContent = stats.ai_messages || 0;
            document.getElementById('requires-attention').textContent = stats.requires_attention || 0;
            document.getElementById('response-rate').textContent = (stats.ai_response_rate || 0).toFixed(1) + '%';
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
    }
}

// Carregar configura√ß√µes
async function loadSettings() {
    try {
        const response = await fetch('/api/ai-settings/', {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Erro ao carregar configura√ß√µes');
        
        const settings = await response.json();
        displaySettings(settings);
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('settings-list').innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar configura√ß√µes</div>';
    }
}

// Exibir configura√ß√µes
function displaySettings(settings) {
    const container = document.getElementById('settings-list');
    
    if (settings.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma configura√ß√£o encontrada</div>';
        return;
    }
    
    container.innerHTML = settings.map(setting => `
        <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <h3 class="text-lg font-semibold">${setting.barber_name}</h3>
                        <span class="px-2 py-1 text-xs rounded-full ${setting.is_enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${setting.is_enabled ? '‚úÖ Ativa' : '‚ùå Inativa'}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                            ${setting.personality_display}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">${setting.custom_instructions || 'Sem instru√ß√µes personalizadas'}</p>
                    <div class="flex space-x-4 mt-2 text-xs text-gray-500">
                        <span>M√°x: ${setting.max_message_length} caracteres</span>
                        <span>Tempo: ${setting.response_time_seconds}s</span>
                    </div>
                </div>
                <button onclick="editSetting(${setting.id})" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Editar
                </button>
            </div>
        </div>
    `).join('');
}

// Editar configura√ß√£o
async function editSetting(id) {
    try {
        const response = await fetch(`/api/ai-settings/${id}/`, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Erro ao carregar configura√ß√£o');
        
        const setting = await response.json();
        
        // Preencher form
        document.getElementById('setting-id').value = setting.id;
        document.getElementById('barber-name').value = setting.barber_name;
        document.getElementById('is-enabled').checked = setting.is_enabled;
        document.getElementById('personality').value = setting.personality;
        document.getElementById('custom-instructions').value = setting.custom_instructions || '';
        document.getElementById('max-message-length').value = setting.max_message_length;
        document.getElementById('response-time').value = setting.response_time_seconds;
        
        // Mostrar modal
        document.getElementById('edit-modal').classList.remove('hidden');
        document.getElementById('edit-modal').classList.add('flex');
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar configura√ß√£o');
    }
}

// Salvar configura√ß√£o
document.getElementById('edit-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('setting-id').value;
    const data = {
        is_enabled: document.getElementById('is-enabled').checked,
        personality: document.getElementById('personality').value,
        custom_instructions: document.getElementById('custom-instructions').value,
        max_message_length: parseInt(document.getElementById('max-message-length').value),
        response_time_seconds: parseInt(document.getElementById('response-time').value)
    };
    
    try {
        const response = await fetch(`/api/ai-settings/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Erro ao salvar');
        
        alert('‚úÖ Configura√ß√µes salvas com sucesso!');
        closeModal();
        loadSettings();
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao salvar configura√ß√µes');
    }
});

// Fechar modal
function closeModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
}

// Obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadSettings();
    
    // Atualizar estat√≠sticas a cada 30 segundos
    setInterval(loadStats, 30000);
});
</script>
{% endblock %}

